<project name="distro.build" default="build" basedir="./" xmlns:antcontrib="antlib:net.sf.antcontrib">

	<loadproperties srcfile="build.properties"/>
<!--
	<property name="cache.type" value="Cluster" />
	<property name="cache.props" value="maint_thread_sleep=5&amp;amp;alive_check=true&amp;amp;initial_connections=1&amp;amp;failback=true&amp;amp;max_busy_time=30&amp;amp;socket_connect_to=3&amp;amp;buffer_size=1&amp;amp;nagle_alg=true&amp;amp;max_idle_time=600&amp;amp;failover=true&amp;amp;max_spare_connections=32&amp;amp;servers=&amp;amp;socket_timeout=30&amp;amp;min_spare_connections=1" />
-->
	<property name="cache.type" value="HotRod" />
	<property name="cache.props" value="infinispan.client.hotrod.server_list=127.0.0.1:11222" />
	<!--
	<property name="cache.props" value="infinispan.client.hotrod.server_list=10.196.109.186:11222" />
	-->

	<import file="${cfdistro.build.file}"/>
	<target name="build" depends="cfdistro.build,createJar">
		<!-- custom error file with links for cfeclipse -->
		<requires-ext resource="${ext.railo.dir}/error.cfm"/>
		<copy file="${ext.railo.dir}/error.cfm" todir="${war.target.dir}/WEB-INF/lib/railo-server/context/library/tag" overwrite="true" />
		<!--
		-->
		<!-- add mappings -->
		<!--
		<mapping physical="${basedir}/../../docs" virtual="/docs"/>
		<mapping physical="${basedir}/../test" virtual="/test"/>
		-->
		<!-- add custom tags example
		<customtag physical="${src.dir}/cfdistro/ext/cfmltags/cfantrunner" virtual="/cfantrunner"/>
		 -->
		
		<!-- add caches -->
		<railo-cache name="infinispan" class="railo.extension.io.cache.infinispan.Infinispan${cache.type}Cache" storage="true" 
			default-type="default-object"
	    	custom="${cache.props}"/>

		<railo-cache name="infinispan-template" class="railo.extension.io.cache.infinispan.Infinispan${cache.type}Cache" storage="false" 
			default-type="default-template"
	    	custom="${cache.props}"/>

		<railo-cache name="infinispan-session" class="railo.extension.io.cache.infinispan.Infinispan${cache.type}Cache" storage="true" 
	    	custom="${cache.props}"/>

		<railo-cache name="infinispan-client" class="railo.extension.io.cache.infinispan.Infinispan${cache.type}Cache" storage="true" 
	    	custom="${cache.props}"/>
	<!--
		<railo-cache class="railo.runtime.cache.eh.EHCacheLite" default-type="default-object" 
			custom="maxelementsondisk=10000000&amp;amp;;timeToIdleSeconds=86400&amp;amp;;maxelementsinmemory=10000&amp;amp;;overflowtodisk=true&amp;amp;;memoryevictionpolicy=LRU&amp;amp;;diskpersistent=true&amp;amp;;timeToLiveSeconds=86400"
			name="infinispan" read-only="false" storage="true"/>
	-->
				
		<copy todir="${war.target.dir}/WEB-INF/railo/lib/">
		    <fileset dir="../lib" includes="*.jar"/>
		</copy>
		<copy todir="${war.target.dir}/WEB-INF/railo/context/admin/cdriver/">
            <fileset dir="../extension/driver" includes="*cfc"/>
		</copy>
		<!-- tell jboss to deploy if using exploded war -->
		<echo file="${jboss.deploy.dir}/${war.name}.war.dodeploy" message="" />

	</target>	

	<target name="no.loader">
		<copy todir="${war.target.dir}/WEB-INF/lib/">
		    <fileset dir="../lib" includes="*.jar"/>
		</copy>
		<delete>
			<!--
            <fileset dir="${war.target.dir}/WEB-INF/lib" includes="apache-xml-xalan.jar,jtds.jar,lowagie.itext.jar,serializer.jar,ss_css2.jar,w3c-dom.jar,xmlparserv2.jar"/>
            <fileset dir="${war.target.dir}/WEB-INF/lib" includes="xml-apis.jar,jtds.jar,lowagie.itext.jar,serializer.jar,ss_css2.jar,w3c-dom.jar,xmlparserv2.jar"/>
			-->
            <fileset dir="${war.target.dir}/WEB-INF/lib" includes="xml-apis.jar,ss_css2.jar,w3c-dom.jar,xmlparserv2.jar"/>
            <fileset dir="${war.target.dir}/WEB-INF/railo/lib" excludes="infinispan-cache.jar"/>
		</delete>
	</target>	
		
	<target name="test.props" >
		<removePropsByRegex regex="jboss\..*"/>
		<load-buildtype-properties buildtype="jboss1.local" />
		<antcontrib:runtarget target="jboss.install" />
		<antcontrib:runtarget target="jboss.configure" />

		<removePropsByRegex regex="jboss\..*"/>
		<load-buildtype-properties buildtype="jboss2.local" />
		<antcontrib:runtarget target="jboss.install" />
		<antcontrib:runtarget target="jboss.configure" />
	</target>	

	<target name="jboss" depends="build">
<!--
		<antcontrib:runtarget target="no.loader" />
-->
		<antcontrib:runtarget target="jar.war" />

		<removePropsByRegex regex="jboss\..*"/>
		<load-buildtype-properties buildtype="jboss1.local" />
		<antcontrib:runtarget target="jboss.install" />
		<copy todir="${jboss.dir}/standalone/deployments/" file="${war.target.dir}" />
		<antcontrib:runtarget target="jboss.configure" />

		<removePropsByRegex regex="jboss\..*"/>
		<load-buildtype-properties buildtype="jboss2.local" />
		<antcontrib:runtarget target="jboss.install" />
		<copy todir="${jboss.dir}/standalone/deployments/" file="${war.target.dir}" />
		<antcontrib:runtarget target="jboss.configure" />

<!--
		<antcontrib:runtarget target="server.start" />
		<open-url url="http://10.0.0.2:8080/railo-infinispan/session/index.cfm" />
		-->
	</target>	

	<target name="infinispan">
		<antcontrib:if><available file="${infinispan.dir}"/><then/>
			<else><antcontrib:runtarget target="infinispan.install" /></else>
		</antcontrib:if>
		<echo message="Creating infinispan.sh script.  To run it type: ./infinispan.sh" />
		<relpath root="${basedir}" full-path="${infinispan.dir}" property="infinispan.dir"/>
		<relpath root="${basedir}" full-path="${basedir}/infinispan-cfg.xml" property="infinispan.config"/>
		<echo file="${basedir}/infinispan.sh"><![CDATA[#! /bin/sh
${infinispan.dir}/bin/startServer.sh -r hotrod -c ${infinispan.config}]]></echo>
		<chmod file="${basedir}/infinispan.sh" perm="ugo+rx"/>
	</target>	

	<target name="createJar">
		<path id="master-classpath">
			<fileset dir="${war.target.dir}/WEB-INF/lib/">
				<include name="*.jar"/>
			 </fileset>
            <fileset dir="../lib/">
                <include name="*.jar"/>
             </fileset>
            <fileset dir="cfdistro/lib/">
                <include name="*.jar"/>
             </fileset>
            <fileset dir="../extension/src/main">
                <include name="jboss-modules.jar"/>
             </fileset>
		</path>
<!--		<javac srcdir="${basedir}/../extension/src" destdir="${basedir}/../bin" >
			 <classpath refid="master-classpath"/>
		</javac>
-->
		<property name="extension.bin.dir" value="${temp.dir}/bin"/>
		<delete dir="${extension.bin.dir}" />
		<mkdir dir="${extension.bin.dir}" />
		<javac-ecj srcdir="${basedir}/../extension/src" destdir="${extension.bin.dir}"
			compliance="1.6" target="1.6"
		    classpath="${toString:master-classpath}"/>

		<jar basedir="${extension.bin.dir}" destfile="${war.target.dir}/WEB-INF/railo/lib/infinispan-cache.jar" />
		<delete dir="${extension.bin.dir}" />
	</target>
	
	
	<!-- these are just here for the Eclipse Ant UI ordering -->
	<target name="build.start.launch">
		<antcontrib:runtarget target="cfdistro.build.start.launch" />
	</target>	

	<target name="build.start" depends="build">
		<antcontrib:runtarget target="server.start" />
	</target>	

	<target name="build.stop">
		<antcontrib:runtarget target="server.stop" />
	</target>	
	
</project>
